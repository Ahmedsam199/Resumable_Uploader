# Stage 1: Build
FROM node:20-bullseye AS builder

WORKDIR /app

# Copy dependency files and install as node user
COPY package*.json ./
RUN npm install

# Copy source and build as node user
COPY . .
RUN npm run build


# Stage 2: Run
FROM node:20-bullseye

WORKDIR /app

# Use node user from the start
USER node

# Copy build output
COPY --from=builder --chown=node:node /app/dist ./dist

# Copy package.json and prisma schema
COPY --chown=node:node package*.json ./
COPY --chown=node:node prisma ./prisma

# Install production dependencies as node user
RUN npm install --only=production --legacy-peer-deps

# Generate Prisma client
RUN npx prisma generate

EXPOSE 3000
CMD ["node", "dist/src/main.js"]
